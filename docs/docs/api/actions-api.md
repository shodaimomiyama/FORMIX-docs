---
sidebar_position: 1
---

# Actions Layer API

The Actions layer provides the primary interface for interacting with FORMIX. All external operations are performed through `DTpresClient` or the underlying `ActionsContainer`.

## Overview

```rust
use formix::actions::client::DTpresClient;
use formix::actions::di::DefaultActionsContainer;
```

The Actions layer exposes:
- `DTpresClient` - High-level client with builder-pattern API
- `ActionsContainer` - DI container aggregating Controller, WorkflowService, and CryptoService
- `ShareBuilder` / `RecoverBuilder` - Type-state builders with compile-time safety

## Dependency Injection

### `ActionsContainer`

Central DI container for the Actions layer, aggregating all dependencies.

```rust
pub struct ActionsContainer<C: CoreCryptoService, ST: StorageService> {
    controller: ControllerContainer<C>,
    workflow_services: WorkflowServiceContainer<ServiceCryptoServiceImpl<C>, ST>,
    crypto_service: Arc<C>,
}
```

**Default concrete type**:

```rust
pub type DefaultActionsContainer =
    ActionsContainer<CoreCryptoServiceImpl, DefaultStorageService>;

pub type DefaultStorageService =
    StorageServiceImpl<ArweaveStorageServiceImpl, ContractStorageImpl<MockAOClient>>;
```

### Creating an ActionsContainer

```rust
// Default (uses in-memory mock AO and Arweave)
let container = DefaultActionsContainer::new();

// With custom storage
let container = DefaultActionsContainer::with_storage(arweave, contract);

// Fully custom dependencies
let container = ActionsContainer::with_dependencies(
    controller, workflow_services, crypto_service
);
```

## Domain Entities

### Secret (Aggregate Root)

Manages the lifecycle and metadata of a secret. Does not hold the actual secret data.

```rust
pub struct Secret {
    id: SecretId,
    threshold_k: u8,                              // Min shares required
    threshold_n: u8,                              // Total shares
    state: SecretState,                           // State machine
    capsule_id: Option<CapsuleId>,                // PRE capsule reference
    share_collection_id: Option<ShareCollectionId>, // Encrypted shares reference
    kfrag_ids: Vec<KFragId>,                      // Distributed key fragments
    owner_public_key: Vec<u8>,                    // Owner's PRE public key
    requester_public_key: Option<Vec<u8>>,        // Requester's PRE public key
    created_at: u64,
}
```

**State Machine**:

```
Initialized → Split → Distributed → Recovered
```

| State | Description |
|-------|-------------|
| `Initialized` | Created, not yet processed |
| `Split` | Shares and capsule created |
| `Distributed` | KFrags distributed to holders |
| `Recovered` | Secret recovered by requester |

### Capsule

Holds a serialized Umbral PRE capsule generated during encryption. Enables proxy re-encryption from owner to requester.

```rust
pub struct Capsule {
    id: CapsuleId,
    secret_id: SecretId,
    capsule_data: Vec<u8>,           // Serialized Umbral Capsule (public)
    owner_public_key: Vec<u8>,       // Owner's PRE public key
    arweave_tx_id: Option<String>,   // Arweave storage reference
    created_at: u64,
}
```

### ShareCollection

Holds all n encrypted Shamir shares for a secret, stored atomically in a single Arweave transaction.

```rust
pub struct ShareCollection {
    id: ShareCollectionId,
    secret_id: SecretId,
    threshold_k: u8,
    threshold_n: u8,
    shares: Vec<EncryptedShareData>,   // All n encrypted shares
    arweave_tx_id: Option<String>,
    created_at: u64,
}

pub struct EncryptedShareData {
    index: u8,                         // Share index (1..=n)
    encrypted_data: Vec<u8>,           // C_i = AES_GCM(k_O, f(i))
}
```

### KFrag

Re-encryption key fragment distributed to Holder-Processes. Contains sensitive cryptographic data.

```rust
#[derive(Zeroize, ZeroizeOnDrop)]
pub struct KFrag {
    id: KFragId,
    secret_id: SecretId,
    holder_index: u8,                  // 1..=n (position in holder set)
    holder_process_id: Option<String>, // AO process ID of assigned holder
    kfrag_data: Vec<u8>,               // Serialized Umbral KeyFrag (SENSITIVE)
    created_at: u64,
}
```

**Security**: Implements `Zeroize` and `ZeroizeOnDrop` to clear sensitive `kfrag_data` from memory.

### CFrag

Re-encrypted capsule fragment generated by Holder-Process.

```rust
pub struct CFrag {
    id: CFragId,
    secret_id: SecretId,
    kfrag_id: KFragId,
    cfrag_data: Vec<u8>,               // Re-encrypted fragment
    holder_process_id: String,
}
```

## Value Objects

### Type-Safe IDs

All entity IDs use the newtype pattern for compile-time type safety:

```rust
pub struct SecretId(String);
pub struct CapsuleId(String);
pub struct ShareCollectionId(String);
pub struct KFragId(String);
pub struct CFragId(String);
```

Each supports `new()`, `generate()` (UUID v4), and `as_str()`.

### KeyPair

Umbral PRE key pair with automatic zeroization of secret key.

```rust
#[derive(Zeroize, ZeroizeOnDrop)]
pub struct KeyPair {
    secret_key: Vec<u8>,    // Zeroized on drop
    public_key: Vec<u8>,    // Not zeroized (public)
}
```

Does not implement `Clone` to prevent accidental copies of secret key material. Debug output redacts the secret key.

### SecretData

Temporary value object for raw secret bytes during Shamir split operations.

```rust
#[derive(Zeroize, ZeroizeOnDrop)]
pub struct SecretData {
    secret_bytes: Vec<u8>,
}
```

## Error Types

### ActionError

```rust
pub enum ActionError {
    ValidationFailed { code: String, message: String },
    WorkflowFailed { message: String },
    ResourceNotFound { resource: String },
    CryptoError { message: String },
    PartialStorageFailure {
        capsule_tx_id: String,
        successful_share_tx_ids: Vec<String>,
        failed_shares: Vec<(String, String)>,
        message: String,
    },
}
```

### DomainError

```rust
pub enum DomainError {
    EntityValidation { entity_type, field, message },
    InvalidStateTransition { entity_type, from_state, to_state, reason },
    BusinessRuleViolation { rule, message },
    ThresholdConstraintViolation { required_threshold, available_shares, operation },
    CryptographicError { operation, details },
    NotFound { entity_type, id },
    StorageError { operation, details },
    // ... and more
}
```

## Next Steps

- [Project Structure](/docs/development/project-structure) - Code organization
- [Development Commands](/docs/development/commands) - Build and test commands
